<!--
File:       recipe_view.html
Authors:    Joshua Coe, Scott McClure, Danita Hodges
Purpose:    Search page for recipes
Version:    1.8
Version Notes:
            1.0 - JC - Initial creation, query
            1.1 - SM - Added conversion function and form
            1.3 - DH - Formal view
            1.4 - JC - Added metric/imperial toggle button and JS function
                       Removed unused table code
                       Added hidden input field for unit_conv
                       corrected variable to match view input
                       set default value for convert_y
            1.5 - JC - updated conversion table
                       added conditional for target yield
            1.6 - DH - Page title, started add to cart function
            1.7 - DH - Fixed directions merge error
            1.8 - JC - Checkbox for conversions, removed JS and button for same
-->

{% extends 'reciplan/base.html'%}
{% block content %}

<style>
    #block{
      padding-left: 3%;
    }
</style>

<title>ReciPlan | {{ recipe.title }}</title>

<div class="container" id="block">
  <div class="row">
    <div class="col-md-6">
      <div class="row">
        <div class="col-md-12">
          <img src="/media/{{ recipe.image }}" width="500px"/>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="row">
        <div class="col-md-12">
          <h1>{{ recipe.title }}</h1>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <hr>
          {{ recipe.description }}
          <hr>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4 d-flex flex-row ">
          <h4>Original Yield: {{recipe.o_yield}}</h4>
        </div>
        <div class="col-md-8 d-flex flex-row ">
          <form method="POST" id="chyield">
            {% csrf_token%}
            <div class="form-row ">
              <div class="form-group col-md-12">
                <label for="convert_y" ><h4>Target Yield:</h4></label>
                <!--Add conditional format for the target yield box-->
                {% if new_yield %}
                  <input id="convert_y" name="convert_y" type="text" maxlength="4" size="4" value={{new_yield}}> 
                {% else %}
                  <input id="convert_y" name="convert_y" type="text" maxlength="4" size="4" value={{recipe.o_yield}}>
                {% endif %}
              </div>
              <div class="row">
                <br>
                <!--Added checkbox for metric conversions-->
                <div class="col-md-12">
                  {% if metric %}
                  <input type="checkbox" name="unit_conv" value="Metric" checked>
                  {% else %}
                  <input type="checkbox" name="unit_conv" value="Metric">
                  {% endif %}
                  <label for="unit_conv">Metric</label>
              </div>
              </div>
              <button type="submit" class="btn btn-warning">Update</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Display ingredients -->
  <div class="row">
    <div class="col-md-12">
      <table class="table" id="ingredient_table">
        <thead>
          <tr>
            <th scope="col">Org Amt</th>
            <th scope="col">UOM</th>
            <th scope="col">Target Amt</th>
            <th scope="col">UOM</th>
            <th scope="col">Ingredient</th>
            <th scope="col"><!--Add to Cart--></th>
          </tr>
        </thead>
        <!--add conditional table fill for converted or original recipe-->
        {% if targs%}
          <tbody>
            {% for ingredient in targs %}
            <tr>
              <td>{{ ingredient.0 }}</td>
              <td>{{ ingredient.1 }}</td>
              <td>{{ ingredient.2 }}</td>
              <td>{{ ingredient.3 }}</td>
              <td>{{ ingredient.4 }}</td>
              <th scope="col">
                <button id="" class="btn atc btn-success">Add to Cart</button>
              </th>
            </tr>
            {% endfor %}

        {% else %}
            {% for ingredient in ingredients %}
            <tr>
              <td id="amt{{ ingredient.amt }}">{{ ingredient.amt }}</td>
              <td id="uom{{ ingredient.unit_of_measure }}">{{ ingredient.unit_of_measure }}</td>
              <td id="target_amt"> - </td>
              <td id="target_UOM"> - </td>
              <td id="ing{{ ingredient.name }}">{{ ingredient.name }}</td>
              <th scope="col">
                <button id="" class="btn atc btn-success">Add to Cart</button>
              </th>
            </tr>
            {% endfor %}
          </tbody>
        {% endif %}
      </table>
    </div>
  </div>

  <!--Display directions-->
  <div class="row">
    <div class="col-md-12">
      <h3>Directions</h3>
      <table class="table">
        <thead>
          <tr>
            <th scope="col">Step</th>
            <th scope="col">Instruction</th>
          </tr>
        </thead>
        <tbody>
          {% for direction in directions %}
            <tr>
              <td>{{ direction.step }}</td>
              <td>{{ direction.instruction }}</td>
            </tr>
          {% endfor %}
        </tbody>
    </div>
  </div>

</div>

<!--Add items to shopping list-->
<script type="text/javascript">
  console.log('This is working');

  if(localStorage.getItem('cart')==null){
    var cart = {};
  }else{
    cart = JSON.parse(localStorage.getItem('cart'));
  }// end if else
  
  $(document).on('click', '.atc', function(){
    console.log("The add to cart button is clicked.");
    var item_id = this.id.toString();
    console.log(item_id);

    if(cart[item_id] != undefined){
      amount = cart[item_id][0] + parseFloat(document.getElementById("amt" + item_id).innerHTML);
      cart[item_id][0] = amount;
    }else{
      amount = parseFloat(document.getElementById("amt" + item_id).innerHTML);
      uom = document.getElementById("uom" + item_id).innerHTML;
      ingredient = document.getElementById("ing" + item_id).innerHTML;
      cart[item_id] = [amount, uom, ingredient];
    }// end if-else
      console.log(cart);
      localStorage.setItem('cart', JSON.stringify(cart));
      document.getElementById("cart").innerHTML = "Cart (" + Object.keys(cart).length + ")";
  });
  
</script>

{% endblock %}